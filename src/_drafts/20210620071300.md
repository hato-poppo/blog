---
title: Vue.js + Rails API での認証方式について
date: 2021-06-20
description: 記事の要約
---

# {{ $frontmatter.title }}

## 目的

## 背景

LocalStorageにトークン入れてる記事多くない？
ダメって意見をよく聞くけどどうしてだろう。
そういう記事では大抵LocalStorageを使う理由が書いていないので、参考にした記事がそうやってたからでなんとなく使っているんじゃないかと邪推。

### セッションベース認証

### トークンベース認証

参考になるページ
[JWTを認証用トークンに使う時に調べたこと - Carpe Diem](https://christina04.hatenablog.com/entry/2016/06/07/123000)
[セキュアなトークン管理方法 - Carpe Diem](https://christina04.hatenablog.com/entry/secure-token-management)

AuthorizationのBearerにトークンを入れてサーバーサイドへ送る必要がある。
この場合、クライアントサイドで「AuthorizationのBearerにトークンを入れる」という作業が必要になるのでJavaScriptでトークンにアクセスできないといけない。
これはHttpOnlyをつけていないcookieか、LocalStorageでないと実現できない。
→　と思っていたけど、Cookieで実装するとCookieでやりとりできるのでヘッダにつける意味がなかった
→　LocalStorageへの保存はCookieでやりとりしないための実装か
　　ただ、保管先としてのみCookieを扱うという方法もある
　　セキュアなのはCookie認証なのかもしれない（Cookieのほうがよりセキュアなので）


トークンが漏洩したときに不正アクセス出来てしまうが、そもそも漏洩するのか
※セッションハイジャック


CookieはCSRFに弱い


セッションベースの認証はDBに保存するらしいが、トークンベースはサーバーサイドに保持しないのではないか
→　トークン認証の実装方法についてこれが参考になる
[OAuth アクセストークンの実装に関する考察 - Qiita](https://qiita.com/TakahikoKawasaki/items/970548727761f9e02bcd)

識別子型と内包型があり、内包型の方がDBに対する負荷がないので良さそうに見える
→　ただし、セッションハイジャックによりトークンが盗まれた場合に中身を見られてしまう危険性があるんじゃないか　って考えた
　　でもセッションハイジャックされてる時点でまずくない？どっちにしても不正アクセスされる可能性あるし
　　あと、見られて困る情報はトークンに入れないようにするので問題なさそう

RS256はよくないって書いてるな

注意点
内包型はアクセストークンの失効が難しい。
識別子型は対象レコードを削除することで失効させることができる。
一方、内包型はアクセストークンの期限が切れるまでは有効なので失効させることが難しい。
また、Cookieであればブラウザを閉じた際に破棄することができるが、LocalStorageは永続的なので共有PCから個人アカウントでログインするような使い方が想定される場面では向かない
→　この場合はCookie認証を使うしかない

あと、内包型はロール管理があるようなシステムだとちょっと面倒かもしれない
ロールを更新する際にトークンも更新しないと、新しい権限が適用されないことになってしまう
→　一般ユーザーとシステム管理者だけのシステムなら必要なときだけ権限チェック入れればいいんじゃないかって思ったけど、ロールが増えたときに実装を買えないといけなくなるので拡張性の面で問題がある



フロントエンド側の表示制御も必要だと考えると、レスポンス自体にユーザー情報やロール情報を含めた上でトークンやCookieを返すという実装になる





