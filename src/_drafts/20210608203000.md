---
title: Rails API でパスワード認証とLDAP認証をサポートする方法について
date: 2021-06-08
description: 記事の要約
---

# {{ $frontmatter.title }}

## 目的

既存のGemモジュールを使ってパスワード認証とLDAP認証の両方をサポートする方法について調べた。
前提として、RailsアプリケーションはAPIモードで作成している。

## 背景

趣味で作ってるRails APIの認証機能を実装するところに差し掛かった。
今まではJWT等を使って自力で実装していたが、今回は既存のGemモジュールを使ってみようかと考えた。

既存のGemなら導入が楽だしセキュリティ面の実装もしっかりしてそう

最有力候補は「Devise」
厳密に言うと「Devise Token Auth」

## 結論

今まで通り自力で実装した方が良いんじゃないかと思った。

## 理由

→　LDAP認証用のモジュールがメンテされてないのが気になる
パスワード認証とLDAP認証の併用に対応してないって書いてる

メンテされてないGemに依存したり、トリッキーな実装になるくらいなら自作した方がよくない？っていう結論

徳丸本とやらを読んでみるべきかな

## 調べたこと

まず、[Devise](https://github.com/heartcombo/devise) をAPIモードで使う方法を調べた。
Deviseは非APIモードに対応している為、フロントエンド部分の生成も前提となっており、今開発しているAPIとは合わない。
ググって出てきたのは [Devise Token Auth](https://github.com/lynndylanhurley/devise_token_auth) だった。
これはAPIモード用のGemらしい。

次は Devise Token Auth について調べた。
特に気になるところはない。
スター数も多く、活発にメンテされているようだった。

あとはLDAP認証が実現できるかどうかを確認する必要がある。
パスワード認証との併用ができるかどうかも重要。

Devise で LDAP認証をサポートする方法で調べてみると以下のGemがヒットした
[cschiewek/devise_ldap_authenticatable: Devise Module for LDAP](https://github.com/cschiewek/devise_ldap_authenticatable)
リリースのタグ付けを見てメンテされていないのかと思っていたけど、RubyGems.org で見てみるとちゃんとメンテされてそうだった
[devise_ldap_authenticatable | RubyGems.org | コミュニティのGemホスティングサービス](https://rubygems.org/gems/devise_ldap_authenticatable/versions/0.8.7)

しかしREADME.mdに
> Devise LDAP Authenticatable works in replacement of Database Authenticatable. This devise plugin has not been tested with DatabaseAuthenticatable enabled at the same time. This is meant as a drop in replacement for DatabaseAuthenticatable allowing for a semi single sign on approach.
と記載されていた。
どうやらパスワード認証とLDAP認証の両方をサポートできるわけではないようだ。
別の方法を探してみる。

Devise Token AuthのIssueでちょうど良いものを見つけた。
[devise_token_auth with LDAP? · Issue #759 · lynndylanhurley/devise_token_auth](https://github.com/lynndylanhurley/devise_token_auth/issues/759)

OmniAuth がLDAP認証をサポートしているとのこと
そもそもOmniAuthについてちゃんと知らないので先に調べる必要があるよね
どうやらOAuthのラッパーモジュールがOmniAuthらしい。

Devise Token Authの公式に、OmniAuthについての記述があったので再度確認
[OmniAuth - devise-token-auth](https://devise-token-auth.gitbook.io/devise-token-auth/config/omniauth)

サポートしているプロバイダーの一覧がある
[List of Strategies · omniauth/omniauth Wiki](https://github.com/omniauth/omniauth/wiki/List-of-Strategies)

LDAP認証用のモジュールはこいつらしい
[omniauth/omniauth-ldap: LDAP strategy for OmniAuth](https://github.com/omniauth/omniauth-ldap)

お世辞にも活発とは言えない。
が、これくらいなら許容範囲と言えるのだろうか。


## 参考

[jwt/ruby-jwt: A ruby implementation of the RFC 7519 OAuth JSON Web Token (JWT) standard.](https://github.com/jwt/ruby-jwt)

## 背景

そもそもの両方をサポートする仕組みについて
→　テスト用ユーザーに既存のユーザーを使いたくないから

前提となる環境ではテスト用のユーザーをこちらで自由に追加できないという難点がある
→　結局、LDAP認証でのユーザーの追加テストが不十分になっているんじゃないかっていう気づきがあった
