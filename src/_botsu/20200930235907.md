---
title: vagrant + プロキシ環境にdocker導入
date: 2020-09-30
description: 記事の要約
---

# {{ $frontmatter.title }}

プロキシを通していない環境（自宅）は問題なかったけど、プロキシを通している環境（職場）では色々躓いたのでメモ  
最初はDocker for Windowsで試していたけど、プロキシ環境下でどうしても上手くいかなかったのでこっちで試した  
※わざわざVagrantで仮想マシン構築してその上にDocker導入するなんてことをするメリットって無いんじゃないかと後から気づいたけど、せっかくなので一応残しておく

導入は[公式のインストール手順](https://docs.docker.com/engine/install/ubuntu/) に沿って進めた

### 環境

* ホストPC
  * OS: Windows 10
* ゲストPC
  * OS: Ubuntu Server 18.04 LTS


### 躓いた所

* docker インストール直後から`curl`コマンドが通らなくなった
* docker インストール後、動作確認の為に`$ sudo docker run hello-world`を実行するとエラーが出る

### curl が通らなくなる件

外部サイトへのcurlが、dockerを入れた直後から通らなくなった

```sh
$ curl www.google.com
curl: (7) Failed to connect to [プロキシサーバー] port [ポート]: No route to host
```

ping は通る
```sh
$ ping www.google.com
```

以下の記事がとても参考になった  
[docker bridge networkのIPアドレス指定での落とし穴（bip指定しても172.17.0.0/16から通信できなくなった）](https://qiita.com/k1tajima/items/bf8a714e39e857963abc)

上の記事と同様の対応でいけそうだったのでそのまま拝借

`daemon.json`を生成
```sh
$ sudo vi /etc/docker/daemon.json
```

以下の記述を追加
```sh
{
    "default-address-pools":[  
        {  
            "base":"192.168.0.0/16",
            "size":24
        }
    ]
}
```

再試行
```sh
$ curl www.google.com
```

→　成功

### docker run でエラーが出る件

```sh
$ sudo docker run hello-world
Unable to find image 'hello-world:latest' locally
docker: Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers).
See 'docker run --help'.
```

→　自宅の環境で試したときは問題なかったのでプロキシが怪しい

オプションでプロキシ設定を追加してみる
```sh
$ sudo docker run hello-world --env HTTP_PROXY="[プロキシサーバー]:[ポート]" --env HTTPS_PROXY="[プロキシサーバー]:[ポート]"
Unable to find image 'hello-world:latest' locally
docker: Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers).
See 'docker run --help'.
```

→　結果変わらず。

dockerのステータスを確認してみる
```sh
$ sudo service docker status
● docker.service - Docker Application Container Engine
   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2020-09-29 22:33:07 JST; 1 day 1h ago
     Docs: https://docs.docker.com
 Main PID: 3500 (dockerd)
    Tasks: 11
   CGroup: /system.slice/docker.service
           └─3500 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
```

`/lib/systemd/system/docker.service`というファイルをロードしているらしい  
ここにプロキシ設定を追加してみる

```sh
$ sudo vi /lib/systemd/system/docker.service
```

`[Service]`の設定項目に以下を追加
```sh
Environment="HTTP_PROXY=[プロキシサーバー]:[ポート]" "HTTPS_PROXY=[プロキシサーバー]:[ポート]"
```

更新を反映
```sh
$ sudo systemctl daemon-reload
$ sudo service docker restart
```

プロキシ設定が反映されていることを確認
```sh
$ sudo docker info

～省略～

 HTTP Proxy: [プロキシサーバー]:[ポート]
 HTTPS Proxy: [プロキシサーバー]:[ポート]
```

再試行
```sh
$ sudo docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
0e03bdcc26d7: Pull complete
Digest: sha256:4cf9c47f86df71d48364001ede3a4fcd85ae80ce02ebad74156906caff5378bc
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
```

→　成功  
  
※`docker run`にオプションでプロキシ設定を追加した時はうまくいかなかった理由が分かっていない

### docker インストール手順

[公式のインストール手順](https://docs.docker.com/engine/install/ubuntu/)そのまま。  
一応ここにも残しておく。

```sh
$ sudo apt-get remove docker docker-engine docker.io containerd runc
```

```sh
$ sudo apt-get update
```

```sh
$ sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
```

```sh
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

```sh
$ sudo apt-key fingerprint 0EBFCD88
```

```sh
$ sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
```

```sh
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
```
